<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EcoPower - Electricity Payment</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0fdf4',
                            100: '#dcfce7',
                            200: '#bbf7d0',
                            300: '#86efac',
                            400: '#4ade80',
                            500: '#22c55e',
                            600: '#16a34a',
                            700: '#15803d',
                            800: '#166534',
                            900: '#14532d',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Poppins', sans-serif;
            background: #ffffff;
        }

        .header-gradient {
            background: linear-gradient(90deg, #166534 0%, #22c55e 100%);
        }

        .card {
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05), 0 10px 10px -5px rgba(0, 0, 0, 0.02);
            border-radius: 16px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px -5px rgba(0, 0, 0, 0.1);
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid rgba(255, 255, 255, .3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .spinner-lg {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: #16a34a;
            animation: spin 1s linear infinite;
        }

        .bill-item {
            transition: all 0.3s ease;
            border-left: 3px solid #22c55e;
        }

        .overdue-item {
            border-left: 3px solid #ef4444;
        }

        .due-badge {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
        }

        .progress-bar {
            height: 8px;
            border-radius: 4px;
            background: #e5e7eb;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #22c55e 0%, #16a34a 100%);
            border-radius: 4px;
        }

        .bill-table td {
            padding: 12px 16px;
            border-bottom: 1px solid #e5e7eb;
        }

        .bill-table tr:last-child td {
            border-bottom: none;
        }

        .payment-history-table {
            width: 100%;
            border-collapse: collapse;
        }

        .payment-history-table th {
            background-color: #f9fafb;
            text-align: left;
            padding: 12px 16px;
            font-weight: 600;
            color: #374151;
            border-bottom: 1px solid #e5e7eb;
        }

        .payment-history-table td {
            padding: 12px 16px;
            border-bottom: 1px solid #e5e7eb;
            color: #4b5563;
        }

        .payment-history-table tr:last-child td {
            border-bottom: none;
        }

        .payment-history-table tr:hover {
            background-color: #f9fafb;
        }

        .payment-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .status-paid {
            background-color: #dcfce7;
            color: #166534;
        }

        .status-pending {
            background-color: #fef3c7;
            color: #92400e;
        }

        .disabled-button {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .error-message {
            background-color: #fef2f2;
            color: #b91c1c;
            padding: 12px 16px;
            border-radius: 8px;
            margin-top: 12px;
            display: flex;
            align-items: flex-start;
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .error-message i {
            margin-right: 10px;
            margin-top: 3px;
        }

        .loading-overlay.hidden {
            display: none !important;
        }

        .overdue-bill-card {
            border-left: 4px solid #ef4444;
            background-color: #fff;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 16px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .overdue-bill-header {
            padding: 12px 16px;
            background-color: #fef2f2;
            font-weight: 600;
            color: #b91c1c;
        }

        .overdue-bill-detail {
            padding: 8px 16px;
            display: flex;
            justify-content: space-between;
            border-bottom: 1px solid #f3f4f6;
        }

        .overdue-bill-detail:last-child {
            border-bottom: none;
        }

        .overdue-bill-footer {
            padding: 12px 16px;
            background-color: #f9fafb;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
        }
    </style>
</head>

<body class="min-h-screen flex flex-col">
    <!-- Main Content -->
    <main class="flex-grow container mx-auto px-4 py-8">
        <div class="max-w-4xl mx-auto">
            <div class="text-center mb-10">
                <h2 class="text-3xl font-bold text-gray-800 mb-3">Electricity Bill Payment</h2>
                <p class="text-gray-600 max-w-lg mx-auto">
                    Quick, secure payments for your electricity bills. View your
                    current charges and overdue amounts in one place.
                </p>
            </div>
            <!-- Account Input Card -->
            <div id="accountInputCard" class="bg-white card p-6 mb-8">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                    <div class="flex items-center mb-4 md:mb-0">
                        <div class="bg-primary-100 p-3 rounded-full mr-4">
                            <i class="fas fa-search text-primary-600 text-xl"></i>
                        </div>
                        <h3 class="text-xl font-semibold text-gray-800">Find Your Account</h3>
                    </div>
                    <div class="bg-primary-50 px-4 py-2 rounded-full text-sm text-primary-700">
                        <i class="fas fa-lightbulb mr-2"></i>Enter your 8-digit account number
                    </div>
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 mb-2 font-medium">Consumer Account Number</label>
                    <div class="relative">
                        <input type="text" id="accountNumber" placeholder="Enter your 8-digit account number"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition text-lg"
                            maxlength="8" />
                        <i class="fas fa-hashtag absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    </div>
                    <div id="accountError" class="hidden bg-red-50 text-red-800 p-3 rounded-lg mb-4 flex items-start">
                        <i class="fas fa-exclamation-circle mt-1 mr-2"></i>
                        <div>
                            <strong class="font-medium">Error:</strong> <span id="errorMessage"></span>
                        </div>
                    </div>
                </div>
                <button id="fetchAccountBtn"
                    class="w-full bg-primary-600 hover:bg-primary-700 text-white font-semibold py-3 px-4 rounded-lg transition flex items-center justify-center">
                    <span>Retrieve Account Details</span>
                    <i class="fas fa-arrow-right ml-2"></i>
                </button>
            </div>
            <!-- Account Details Card (Initially Hidden) -->
            <div id="accountDetails" class="bg-white card p-6 hidden">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                    <div class="flex items-center mb-4 md:mb-0">
                        <div class="bg-primary-100 p-3 rounded-full mr-4">
                            <i class="fas fa-user-circle text-primary-600 text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold text-gray-800">Account Details</h3>
                            <p class="text-gray-600 text-sm">View your billing information and payment options</p>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div class="bg-gray-50 p-5 rounded-xl">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <p class="text-gray-600 text-sm">Account Holder</p>
                                <p id="fullName" class="font-semibold text-gray-800 text-lg">-</p>
                            </div>
                            <div class="bg-white p-2 rounded-lg">
                                <i class="fas fa-user text-primary-600"></i>
                            </div>
                        </div>
                        <div class="flex justify-between">
                            <div>
                                <p class="text-gray-600 text-sm">Account Number</p>
                                <p id="accountNum" class="font-semibold text-gray-800">-</p>
                            </div>
                            <div>
                                <p class="text-gray-600 text-sm">Last Payment</p>
                                <p id="lastPaymentDate" class="font-semibold text-gray-800">-</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-primary-50 p-5 rounded-xl">
                        <div class="flex justify-between items-center mb-3">
                            <p class="text-gray-700 font-medium">Total Amount Due</p>
                            <p id="accountBalance" class="text-2xl font-bold text-gray-800">-</p>
                        </div>
                        <div class="mb-2">
                            <div class="flex justify-between text-sm text-gray-600">
                                <span>Due Date</span>
                                <span id="dueDate">-</span>
                            </div>
                        </div>
                        <div class="progress-bar">
                            <div id="dueProgress" class="progress-fill" style="width: 70%"></div>
                        </div>
                    </div>
                </div>
                <!-- Bill Breakdown -->
                <div class="mb-8">
                    <h4 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-file-invoice mr-3 text-primary-600"></i> Bill Breakdown
                    </h4>
                    <!-- Current Bill -->
                    <div class="mb-6">
                        <h5 class="text-md font-medium text-gray-700 mb-3 flex items-center">
                            <i class="fas fa-bolt text-green-500 mr-2"></i> Current Bill
                            <span id="dueIndicator"
                                class="ml-auto text-sm font-normal bg-green-100 text-green-800 px-2 py-1 rounded">
                                -
                            </span>
                        </h5>
                        <div class="bg-white border border-gray-200 rounded-xl overflow-hidden">
                            <table class="w-full bill-table" id="currentBillTable">
                                <tr>
                                    <td>Bill ID</td>
                                    <td id="currentBillId" class="text-right font-mono">-</td>
                                </tr>
                                <tr>
                                    <td id="billPeriod">-</td>
                                    <td class="text-right">
                                        <span id="billAmount">0.00</span>
                                    </td>
                                </tr>
                                <tr class="bg-gray-50">
                                    <td class="font-semibold">Current Bill Total</td>
                                    <td id="currentBillTotal" class="text-right font-semibold">-</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    <!-- Overdue Bills -->
                    <div class="mb-6">
                        <h5 class="text-md font-medium text-gray-700 mb-3 flex items-center">
                            <i class="fas fa-exclamation-triangle text-red-500 mr-2"></i> Overdue Bills
                            <span
                                class="ml-auto text-sm font-normal bg-red-100 text-red-800 px-2 py-1 rounded due-badge">
                                over 30 days
                            </span>
                        </h5>
                        <div id="overdueBillsContainer" class="space-y-4">
                            <!-- Overdue bills will be populated here dynamically -->
                        </div>
                        <div class="bg-gray-50 border-t border-gray-200 p-4 mt-4">
                            <div class="flex justify-between">
                                <div class="font-semibold">Overdue Bills Total</div>
                                <div class="font-semibold" id="overdueTotalAmount">₱0.00</div>
                            </div>
                        </div>
                    </div>
                    <!-- Total Amount -->
                    <div class="bg-primary-50 border border-primary-200 rounded-xl p-5">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-gray-700 font-medium">Total Amount Due</p>
                                <p class="text-sm text-gray-600">Includes all current and overdue charges</p>
                            </div>
                            <p id="totalAmount" class="text-2xl font-bold text-gray-800">₱2,779.76</p>
                        </div>
                    </div>
                </div>
                <!-- Payment History -->
                <div class="border-t border-gray-200 pt-6">
                    <h4 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-history mr-3 text-primary-600"></i> Payment History
                    </h4>
                    <div class="overflow-x-auto rounded-lg border border-gray-200 mb-6">
                        <table class="payment-history-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Transaction ID</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="paymentHistoryBody">
                                <!-- Rows will be inserted here dynamically -->
                            </tbody>
                        </table>
                    </div>
                    <button id="confirmPaymentBtn"
                        class="w-full bg-primary-600 hover:bg-primary-700 text-white font-semibold py-4 px-4 rounded-lg transition flex items-center justify-center text-lg">
                        <i class="fas fa-lock mr-3"></i>
                        <span>Pay ₱2,779.76 Now</span>
                    </button>
                    <button id="cancelAccountBtn"
                        class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-4 px-4 rounded-lg transition flex items-center justify-center text-lg mt-4">
                        <i class="fas fa-times mr-3"></i>
                        <span>Cancel</span>
                    </button>
                    <p class="text-xs text-gray-500 mt-3 text-center">
                        <i class="fas fa-shield-alt mr-1"></i> Your payment is secured with 256-bit encryption
                    </p>
                </div>
            </div>
            <!-- Payment Confirmation (Initially Hidden) -->
            <div id="paymentConfirmation" class="bg-white card p-6 hidden">
                <div class="text-center py-8">
                    <div class="flex justify-center mb-6">
                        <div class="bg-green-100 w-20 h-20 rounded-full flex items-center justify-center">
                            <i class="fas fa-check text-green-600 text-3xl"></i>
                        </div>
                    </div>
                    <h3 class="text-2xl font-semibold text-gray-800 mb-2">Payment Successful!</h3>
                    <p class="text-gray-600 mb-6 max-w-md mx-auto">
                        Your electricity bill payment has been processed
                        successfully. A receipt has been sent to your email.
                    </p>
                    <div class="bg-green-50 border border-green-200 rounded-xl p-6 max-w-md mx-auto mb-8">
                        <div class="grid grid-cols-2 gap-4 text-left">
                            <div>
                                <p class="text-gray-600 text-sm">Amount Paid:</p>
                                <p id="paidAmount" class="font-medium text-gray-800">₱2,779.76</p>
                            </div>
                            <div>
                                <p class="text-gray-600 text-sm">Account Number:</p>
                                <p id="paidAccount" class="font-medium text-gray-800">AC982345</p>
                            </div>
                            <div>
                                <p class="text-gray-600 text-sm">Transaction ID:</p>
                                <p class="font-medium text-green-600">TX984732</p>
                            </div>
                            <div>
                                <p class="text-gray-600 text-sm">Date:</p>
                                <p id="paymentDate" class="font-medium text-gray-800">July 18, 2023</p>
                            </div>
                        </div>
                    </div>
                    <div class="flex flex-col sm:flex-row justify-center gap-4">
                        <button id="newPaymentBtn"
                            class="bg-primary-600 hover:bg-primary-700 text-white font-semibold py-3 px-8 rounded-lg transition">
                            <i class="fas fa-receipt mr-2"></i>View Receipt
                        </button>
                        <button id="anotherPaymentBtn"
                            class="bg-white border border-primary-600 text-primary-600 hover:bg-primary-50 font-semibold py-3 px-8 rounded-lg transition">
                            <i class="fas fa-bolt mr-2"></i>Make Another Payment
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="text-center">
            <div class="spinner-lg mb-4"></div>
            <p class="text-gray-700 font-medium">Processing your request</p>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // DOM Elements
            const accountNumberInput = document.getElementById('accountNumber');
            const fetchAccountBtn = document.getElementById('fetchAccountBtn');
            const accountDetails = document.getElementById('accountDetails');
            const accountInputCard = document.getElementById('accountInputCard');
            const cancelAccountBtn = document.getElementById('cancelAccountBtn');
            const paymentConfirmation = document.getElementById('paymentConfirmation');
            const loadingOverlay = document.getElementById('loadingOverlay');
            const fullNameElement = document.getElementById('fullName');
            const accountNumElement = document.getElementById('accountNum');
            const lastPaymentElement = document.getElementById('lastPaymentDate');
            const accountBalanceElement = document.getElementById('accountBalance');
            const totalAmountElement = document.getElementById('totalAmount');
            const dueIndicator = document.getElementById('dueIndicator');
            const dueDateElement = document.getElementById('dueDate');
            const dueProgress = document.getElementById('dueProgress');
            const paidAmountElement = document.getElementById('paidAmount');
            const paidAccountElement = document.getElementById('paidAccount');
            const paymentDateElement = document.getElementById('paymentDate');
            const confirmPaymentBtn = document.getElementById('confirmPaymentBtn');
            const newPaymentBtn = document.getElementById('newPaymentBtn');
            const anotherPaymentBtn = document.getElementById('anotherPaymentBtn');
            const billPeriod = document.getElementById('billPeriod');
            const billAmount = document.getElementById('billAmount');
            const currentBillTotal = document.getElementById('currentBillTotal');
            const overdueBillsContainer = document.getElementById('overdueBillsContainer');
            const overdueTotalAmount = document.getElementById('overdueTotalAmount');

            // Utility Functions
            function formatDate(dateString) {
                const options = { year: 'numeric', month: 'long', day: 'numeric' };
                return new Date(dateString).toLocaleDateString(undefined, options);
            }

            function showError(message) {
                const errorMessage = document.getElementById('errorMessage');
                const accountError = document.getElementById('accountError');
                errorMessage.textContent = message;
                accountError.classList.remove('hidden');
                setTimeout(() => accountError.classList.add('hidden'), 5000);
            }

            function showLoading() {
                loadingOverlay.classList.remove('hidden');
            }

            function hideLoading() {
                loadingOverlay.classList.add('hidden');
            }

            function calculateDaysRemaining(dueDate) {
                const today = new Date();
                const due = new Date(dueDate);
                const timeDiff = due - today;
                return Math.ceil(timeDiff / (1000 * 60 * 60 * 24));
            }

            function calculateProgress(dueDate) {
                const totalDays = 30; // Total billing cycle days
                const daysRemaining = Math.min(totalDays, calculateDaysRemaining(dueDate));
                const daysPassed = totalDays - daysRemaining;
                return Math.min(100, Math.max(0, (daysPassed / totalDays) * 100));
            }

            async function fetchAccountDetails(accountNumber) {
                const url = '/v1/employee/sysadmin/payment/verify-account-number';
                const options = {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ accountNumber })
                };

                try {
                    const response = await fetch(url, options);
                    const data = await response.json();

                    if (!response.ok) {
                        if (response.status === 404) {
                            throw new Error(data.error || 'No data found');
                        }
                        throw new Error(data.error || 'Failed to fetch account details');
                    }

                    return data;
                } catch (error) {
                    throw new Error(error.message || 'An error occurred while fetching account details');
                }
            }

            // Updated processPayment function
            async function processPayment(totalAmount, accountNumber, billIds) {
                const url = '/v1/employee/sysadmin/payment/process-payment';
                const options = {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        accountNumber,
                        amount: totalAmount,
                        billIds
                    })
                };

                try {
                    const response = await fetch(url, options);
                    const data = await response.json();
                    if (!response.ok) {
                        throw new Error(data.error || 'Payment processing failed');
                    }
                    return data;
                } catch (error) {
                    throw new Error(error.message || 'An error occurred while processing payment');
                }
            }

            function renderAccountDetails(accountData) {
                fullNameElement.textContent = `${accountData.firstName} ${accountData.middleName} ${accountData.lastName} ${accountData.suffix}`;
                accountNumElement.textContent = accountData.accountNumber;
                lastPaymentElement.textContent = formatDate(accountData.lastPaymentDate);
                accountBalanceElement.textContent = `₱${accountData.totalAmount.toFixed(2)}`;
                totalAmountElement.textContent = `₱${accountData.totalAmount.toFixed(2)}`;

                // Update due date and progress
                dueDateElement.textContent = formatDate(accountData.dueDate);
                const daysRemaining = calculateDaysRemaining(accountData.dueDate);
                const progressPercent = calculateProgress(accountData.dueDate);

                if (daysRemaining < 0) {
                    dueIndicator.textContent = `Overdue by ${Math.abs(daysRemaining)} days`;
                    dueIndicator.className = 'ml-auto bg-red-100 text-red-800 px-4 py-2 rounded text-sm font-medium';
                } else {
                    dueIndicator.textContent = `Due in ${daysRemaining} days`;
                    dueIndicator.className = 'ml-auto bg-green-100 text-green-800 px-4 py-2 rounded text-sm font-medium';
                }
                dueProgress.style.width = `${progressPercent}%`;
                console.log(progressPercent)

                // Update current bill details
                document.getElementById('currentBillId').textContent = accountData.currentBill.id;
                billPeriod.textContent = `${accountData.currentBill.currentBillMonth} ${accountData.currentBill.currentBillYear}`;
                billAmount.textContent = `₱${accountData.currentBill.currentBillAmount.toFixed(2)}`;
                currentBillTotal.textContent = `₱${accountData.currentBill.currentBillAmount.toFixed(2)}`;


                // Render overdue bills (unchanged)
                renderOverdueBills(accountData.overdueBills);

                const paymentHistoryBody = document.getElementById('paymentHistoryBody');
                paymentHistoryBody.innerHTML = '';
                accountData.paymentHistory.forEach(transaction => {
                    const formattedDate = formatDate(transaction.date);
                    const statusClass = `status-${transaction.status.toLowerCase()}`;
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${formattedDate}</td>
                        <td>${transaction.transactionId}</td>
                        <td class="text-left">₱${transaction.amount.toFixed(2)}</td>
                        <td><span class="payment-status ${statusClass}">${transaction.status}</span></td>
                    `;
                    paymentHistoryBody.appendChild(row);
                });

                if (accountData.totalAmount <= 0) {
                    confirmPaymentBtn.disabled = true;
                    confirmPaymentBtn.classList.add('disabled-button');
                    confirmPaymentBtn.textContent = "Pay ₱0.00 Now";
                } else {
                    confirmPaymentBtn.disabled = false;
                    confirmPaymentBtn.classList.remove('disabled-button');
                    confirmPaymentBtn.innerHTML = `<i class="fas fa-lock mr-3"></i><span>Pay ₱${accountData.totalAmount.toFixed(2)} Now</span>`;
                }
            }

            function renderOverdueBills(overdueBills) {
                overdueBillsContainer.innerHTML = '';
                let totalOverdue = 0;

                if (overdueBills.length === 0) {
                    const emptyMessage = document.createElement('div');
                    emptyMessage.className = 'text-center py-6 text-gray-500';
                    emptyMessage.innerHTML = '<i class="fas fa-check-circle mr-2 text-green-500"></i> No overdue bills';
                    overdueBillsContainer.appendChild(emptyMessage);
                } else {
                    overdueBills.forEach(bill => {
                        const billTotal = bill.baseAmount + bill.interestAmount + bill.serviceFee;
                        totalOverdue += billTotal;

                        const billElement = document.createElement('div');
                        billElement.className = 'overdue-bill-card';
                        billElement.innerHTML = `
                            <div class="overdue-bill-header">
                                ${bill.month} ${bill.year} (${bill.daysOverdue} days overdue)
                            </div>
							<div class="overdue-bill-detail">
								<div>Bill ID</div>
								<div class="font-mono">${bill.id}</div>
							</div>
                            <div class="overdue-bill-detail">
                                <div>Base Amount</div>
                                <div>₱${bill.baseAmount.toFixed(2)}</div>
                            </div>
                            <div class="overdue-bill-detail">
                                <div>Interest (${bill.interestRate}%)</div>
                                <div>₱${bill.interestAmount.toFixed(2)}</div>
                            </div>
                            <div class="overdue-bill-detail">
                                <div>Service Fee</div>
                                <div>₱${bill.serviceFee.toFixed(2)}</div>
                            </div>
                            <div class="overdue-bill-footer">
                                <div>Total for ${bill.month} ${bill.year}</div>
                                <div>₱${billTotal.toFixed(2)}</div>
                            </div>
                        `;
                        overdueBillsContainer.appendChild(billElement);
                    });
                }

                overdueTotalAmount.textContent = `₱${totalOverdue.toFixed(2)}`;
            }

            function renderPaymentConfirmation(paymentData) {
                paidAmountElement.textContent = `₱${paymentData.amount.toFixed(2)}`;
                paidAccountElement.textContent = paymentData.accountNumber;
                paymentDateElement.textContent = formatDate(paymentData.date);
            }

            // Event Handlers
            fetchAccountBtn.addEventListener('click', async function () {
                const accountNumber = accountNumberInput.value.trim();
                if (!accountNumber || !/^\d{8}$/.test(accountNumber)) {
                    showError('Please enter a valid 8-digit account number');
                    return;
                }
                showLoading();
                try {
                    const accountData = await fetchAccountDetails(accountNumber);
                    window.currentAccountData = accountData;
                    renderAccountDetails(accountData);
                    accountInputCard.classList.add('hidden');
                    accountDetails.classList.remove('hidden');
                    accountDetails.scrollIntoView({ behavior: 'smooth', block: 'start' });
                } catch (error) {
                    accountDetails.classList.add('hidden');
                    showError(error.message);
                } finally {
                    hideLoading();
                }
            });

            cancelAccountBtn.addEventListener('click', function () {
                accountDetails.classList.add('hidden');
                accountInputCard.classList.remove('hidden');
            });

            confirmPaymentBtn.addEventListener('click', async function () {
                if (confirmPaymentBtn.disabled) return;
                showLoading();
                try {
                    const totalAmount = parseFloat(totalAmountElement.textContent.replace('₱', ''));
                    const accountNumber = accountNumElement.textContent;

                    // Collect bill IDs
                    const billIds = [];
                    billIds.push(currentAccountData.currentBill.id);
                    currentAccountData.overdueBills.forEach(bill => {
                        billIds.push(bill.id);
                    });

                    const paymentData = await processPayment(totalAmount, accountNumber, billIds);
                    renderPaymentConfirmation(paymentData);
                    accountDetails.classList.add('hidden');
                    paymentConfirmation.classList.remove('hidden');
                    paymentConfirmation.scrollIntoView({ behavior: 'smooth' });
                } catch (error) {
                    console.error('Error processing payment:', error);
                    alert('An unexpected error occurred. Please try again.');
                } finally {
                    hideLoading();
                }
            });

            anotherPaymentBtn.addEventListener('click', function () {
                paymentConfirmation.classList.add('hidden');
                accountInputCard.classList.remove('hidden');
                accountNumberInput.value = '';
                accountNumberInput.focus();
            });

            newPaymentBtn.addEventListener('click', function () {
                alert('Receipt downloaded! Transaction ID: TX984732');
            });

        });
    </script>
</body>

</html>